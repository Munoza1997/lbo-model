<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LBO Model">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Casavo Growers Inc. LBO Model Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #003d5c 0%, #005a82 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #003d5c 0%, #005a82 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .scenario-toggle {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .scenario-btn {
            padding: 12px 30px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .scenario-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .scenario-btn.active {
            background: white;
            color: #003d5c;
        }

        .content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 15px;
            padding: 20px;
            transition: grid-template-columns 0.3s ease;
        }
        
        .content.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }
        
        .sidebar {
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 200px);
            transition: all 0.3s ease;
        }
        
        .content.sidebar-collapsed .sidebar {
            width: 0;
            padding: 0;
            opacity: 0;
            pointer-events: none;
        }
        
        .toggle-sidebar {
            position: fixed;
            left: 20px;
            top: 140px;
            z-index: 1000;
            background: #003d5c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .toggle-sidebar:hover {
            background: #005a82;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            color: #003d5c;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 3px solid #003d5c;
            padding-bottom: 8px;
        }

        .section h3 {
            color: #005a82;
            margin: 15px 0 10px 0;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #333;
            font-size: 0.8em;
        }

        .input-group input:not([type="checkbox"]) {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #003d5c;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .input-row-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .input-row-5 input {
            padding: 4px;
            font-size: 0.75em;
        }

        .year-label {
            font-size: 0.7em;
            text-align: center;
            color: #666;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .returns-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .returns-card {
            background: linear-gradient(135deg, #003d5c 0%, #005a82 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .returns-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
        }

        .returns-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .returns-card .subtitle {
            font-size: 0.95em;
            opacity: 0.85;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 0.75em;
        }

        th, td {
            padding: 6px 8px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
            min-width: 100px;
            white-space: nowrap;
        }
        
        th:first-child,
        td:first-child {
            min-width: 200px;
            text-align: left;
            font-weight: 600;
        }

        th {
            background: #003d5c;
            color: white;
            font-weight: 600;
            font-size: 0.8em;
        }

        th:first-child,
        td:first-child {
            text-align: left;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            position: sticky;
            left: 0;
            border-right: 2px solid #003d5c;
            min-width: 160px;
        }

        tbody tr:hover {
            background: #f0f0f0;
        }

        tbody tr:hover td:first-child {
            background: #e8e9ea;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #003d5c;
        }

        .summary-item label {
            display: block;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .full-width {
            grid-column: 1 / -1;
            overflow-x: auto;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #003d5c #f0f0f0;
        }
        
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #003d5c;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #005a82;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
        }

        .metric-section {
            background: #e8ecf4;
            font-weight: bold;
        }

        .metric-section td {
            background: #e8ecf4 !important;
        }

        .sidebar {
            overflow-y: auto;
            max-height: calc(100vh - 100px);
        }

        .info-text {
            font-size: 0.7em;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        @media (max-width: 1600px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="dashboardTitle">ðŸ“Š Casavo Growers Inc. LBO Model Dashboard</h1>
            <p>Leveraged Buyout Analysis & Valuation Model</p>
            <div class="scenario-toggle">
                <button class="scenario-btn active" onclick="setScenario('base')">BASE</button>
                <button class="scenario-btn" onclick="setScenario('bear')">BEAR</button>
                <button class="scenario-btn" onclick="setScenario('bull')">BULL</button>
            </div>
        </div>

        <button class="toggle-sidebar" onclick="toggleSidebar()">â˜° Toggle Inputs</button>

        <div class="content">
            <!-- Left Sidebar: Inputs -->
            <div class="sidebar">
                <div class="section">
                    <h2>Starting Assumptions</h2>
                    
                    <!-- Excel Upload Feature -->
                    <div style="background: linear-gradient(135deg, #003d5c 0%, #005a82 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <label style="color: white; font-weight: bold; font-size: 1em; display: block; margin-bottom: 10px;">
                            ðŸ“‚ Upload Excel File
                        </label>
                        <input type="file" id="excelUpload" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelUpload(event)">
                        <button onclick="document.getElementById('excelUpload').click()" style="width: 100%; padding: 10px; background: white; color: #003d5c; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.9em;">
                            Choose Excel File
                        </button>
                        <div id="uploadStatus" style="color: white; font-size: 0.85em; margin-top: 8px; text-align: center;"></div>
                    </div>
                    
                    <div class="input-group" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #003d5c;">
                        <label style="font-size: 1.1em; font-weight: bold; color: #003d5c;">Company Name</label>
                        <input type="text" id="companyName" value="Casavo Growers Inc." placeholder="Enter company name..." onchange="updateTitle()">
                    </div>
                    
                    <h3>Company Info</h3>
                    <div class="input-group">
                        <label>LTM EBITDA ($M)</label>
                        <input type="number" id="ltmEbitda" value="31.931" step="0.001">
                    </div>
                    <div class="input-group">
                        <label>LTM Revenue ($M)</label>
                        <input type="number" id="ltmRevenue" value="693.712" step="0.001">
                    </div>
                    <div class="input-group">
                        <label>Historical Cash from B/S ($M)</label>
                        <input type="number" id="beginCash" value="63.754" step="0.001">
                    </div>
                    <div class="input-group">
                        <label>Shares Outstanding (M)</label>
                        <input type="number" id="shares" value="17.5" step="0.1">
                    </div>
                    
                    <h3>Entry Assumptions</h3>
                    <div class="input-group">
                        <label>Entry EV/EBITDA Multiple</label>
                        <input type="number" id="entryMultiple" value="10.4" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Transaction Fees (% TEV)</label>
                        <input type="number" id="transactionFees" value="1.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Financing Fees (% Debt)</label>
                        <input type="number" id="financingFees" value="1.75" step="0.25">
                    </div>
                    <div class="input-group">
                        <label>Rollover Equity (%)</label>
                        <input type="number" id="rolloverEquity" value="10" step="1">
                    </div>
                    <div class="input-group">
                        <label>Min Cash Balance ($M)</label>
                        <input type="number" id="minCash" value="10.0" step="0.5">
                    </div>
                    
                    <h3>Debt Structure</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>RCF Size ($M)</label>
                            <input type="number" id="revolverSize" value="60.0" step="5">
                        </div>
                        <div class="input-group">
                            <label>RCF Spread (bps)</label>
                            <input type="number" id="revolverSpread" value="250" step="25">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>TLB Leverage (x)</label>
                            <input type="number" id="termLoanLeverage" value="3.0" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>TLB Spread (bps)</label>
                            <input type="number" id="termLoanSpread" value="450" step="25">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>TLB Mandatory Amort (%)</label>
                        <input type="number" id="termLoanAmort" value="1.0" step="0.25">
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Sub Debt Lev (x)</label>
                            <input type="number" id="subDebtLeverage" value="1.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Sub Debt Rate (%)</label>
                            <input type="number" id="subDebtRate" value="12.5" step="0.25">
                        </div>
                    </div>
                    
                    <h3>Exit Assumptions</h3>
                    <div class="input-group">
                        <label>Exit Multiple (Base)</label>
                        <input type="number" id="exitMultipleBase" value="10.4" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Multiple Expansion (Bear)</label>
                        <input type="number" id="multipleExpBear" value="-0.5" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Multiple Expansion (Bull)</label>
                        <input type="number" id="multipleExpBull" value="0.5" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Exit Transaction Fees (%)</label>
                        <input type="number" id="exitFees" value="1.0" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>MIP Stake at Exit (%)</label>
                        <input type="number" id="mipStake" value="15" step="1">
                    </div>
                    <div class="input-group">
                        <label>IRR Target (%)</label>
                        <input type="number" id="irrTarget" value="20.0" step="1">
                    </div>
                    
                    <h3>Other</h3>
                    <div class="input-group">
                        <label>Tax Rate (%)</label>
                        <input type="number" id="taxRate" value="35.8" step="0.1">
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="cashSweep">
                        <label for="cashSweep">Charge Interest (Cash Sweep ON)</label>
                    </div>
                </div>

                <div class="section">
                    <h2>Scenario Assumptions</h2>
                    <p class="info-text">Adjust values for each year in the selected scenario</p>
                    
                    <h3>Revenue Growth (%)</h3>
                    <div class="input-row-5">
                        <div class="year-label">Y1</div>
                        <div class="year-label">Y2</div>
                        <div class="year-label">Y3</div>
                        <div class="year-label">Y4</div>
                        <div class="year-label">Y5</div>
                    </div>
                    <div class="input-row-5" id="revenueGrowthInputs"></div>
                    
                    <h3>Gross Margin (%)</h3>
                    <div class="input-row-5" id="grossMarginInputs"></div>
                    
                    <h3>SG&A Margin (%)</h3>
                    <div class="input-row-5" id="sgaMarginInputs"></div>
                    
                    <h3>CapEx (% Revenue)</h3>
                    <div class="input-row-5" id="capexInputs"></div>
                    
                    <h3>AR Days</h3>
                    <div class="input-row-5" id="arDaysInputs"></div>
                    
                    <h3>Inventory Days</h3>
                    <div class="input-row-5" id="invDaysInputs"></div>
                    
                    <h3>AP Days</h3>
                    <div class="input-row-5" id="apDaysInputs"></div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Returns Summary -->
                <div class="returns-grid">
                    <div class="returns-card">
                        <h3>IRR</h3>
                        <div class="value"><span id="irr">0.0</span>%</div>
                        <div class="subtitle">Internal Rate of Return</div>
                    </div>
                    <div class="returns-card">
                        <h3>MOIC</h3>
                        <div class="value"><span id="moic">0.0</span>x</div>
                        <div class="subtitle">Multiple on Invested Capital</div>
                    </div>
                    <div class="returns-card">
                        <h3>Equity Value @ Exit</h3>
                        <div class="value" id="equityValueExit">$0M</div>
                        <div class="subtitle">$<span id="valuePerShare">0.00</span> / share</div>
                    </div>
                </div>

                <!-- Summary Metrics -->
                <div class="section">
                    <h2>Sources and Uses</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Left side: Summary -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <table style="font-size: 0.8em; width: 100%;">
                                <tr>
                                    <td style="text-align: left; padding: 8px 0;">LTM EBITDA</td>
                                    <td style="text-align: right; font-weight: 600;" id="suLtmEbitda">31,931</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 8px 0;">Implied EV / EBITDA Multiple</td>
                                    <td style="text-align: right; font-weight: 600;" id="suMultiple">10.4x</td>
                                </tr>
                                <tr style="font-weight: bold; border-top: 2px solid #003d5c;">
                                    <td style="text-align: left; padding: 8px 0;">Transaction Enterprise Value</td>
                                    <td style="text-align: right;" id="suTEV">332,082</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 8px 0;">(-) Refinance Existing Debt</td>
                                    <td style="text-align: right;" id="suRefDebt">-</td>
                                </tr>
                                <tr style="font-weight: bold; border-top: 1px solid #ccc; border-bottom: 2px solid #003d5c;">
                                    <td style="text-align: left; padding: 8px 0;">Cash to Existing Shareholders</td>
                                    <td style="text-align: right;" id="suCashToShareholders">332,082</td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- Right side: Sources and Uses tables -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <!-- Sources Table -->
                            <table style="font-size: 0.75em; width: 100%; margin-bottom: 15px;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #003d5c;">
                                        <th style="text-align: left; padding: 6px 0; background: transparent; color: #003d5c;">Sources</th>
                                        <th style="text-align: right; padding: 6px 0; background: transparent; color: #003d5c;">Amount ($)</th>
                                        <th style="text-align: right; padding: 6px 0; background: transparent; color: #003d5c;">x EBITDA</th>
                                        <th style="text-align: right; padding: 6px 0; background: transparent; color: #003d5c;">%</th>
                                    </tr>
                                </thead>
                                <tbody id="sourcesTableBody">
                                </tbody>
                            </table>
                            
                            <!-- Uses Table -->
                            <table style="font-size: 0.75em; width: 100%;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #003d5c;">
                                        <th style="text-align: left; padding: 6px 0; background: transparent; color: #003d5c;">Uses</th>
                                        <th style="text-align: right; padding: 6px 0; background: transparent; color: #003d5c;">Amount ($)</th>
                                        <th style="text-align: right; padding: 6px 0; background: transparent; color: #003d5c;">x EBITDA</th>
                                        <th style="text-align: right; padding: 6px 0; background: transparent; color: #003d5c;">%</th>
                                    </tr>
                                </thead>
                                <tbody id="usesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Returns Sensitivity Analysis -->
                <div class="section">
                    <h2>Returns Sensitivity Analysis</h2>
                    
                    <!-- Purchase Price Build -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #005a82; font-size: 0.9em; margin-bottom: 10px;">Purchase Price Build</h3>
                        <table style="font-size: 0.8em;">
                            <tr>
                                <td style="text-align: left;">LTM EBITDA</td>
                                <td id="sensLtmEbitda">31.9</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">Purchase Multiple</td>
                                <td id="sensPurchaseMultiple">10.4x</td>
                            </tr>
                            <tr style="font-weight: bold;">
                                <td style="text-align: left;">Transaction Enterprise Value</td>
                                <td id="sensTEV">332.1</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(+) Cash from B/S</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(-) Existing Debt</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">Cash to Existing Shareholders</td>
                                <td id="sensCashToShareholders">332.1</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(+) Repay Existing Debt</td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(+) Transaction Fees</td>
                                <td id="sensTransFees">3.3</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(+) Financing Fees</td>
                                <td id="sensFinFees">2.5</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(+) Minimum Cash on Balance Sheet</td>
                                <td id="sensMinCash">10.0</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(-) Cash from B/S</td>
                                <td id="sensCashFromBS">-</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(-) New Debt</td>
                                <td id="sensNewDebt">(143.6)</td>
                            </tr>
                            <tr>
                                <td style="text-align: left;">(-) Rollover Equity</td>
                                <td id="sensRollover">(14.0)</td>
                            </tr>
                            <tr style="font-weight: bold; background: #fffacd;">
                                <td style="text-align: left;">Sponsor Equity</td>
                                <td id="sensSponsorEquity">126.4</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Sponsor Cash Flows & Returns Grid -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="color: #005a82; font-size: 0.9em; margin-bottom: 10px;">Sponsor Cash Flows</h3>
                        <div style="overflow-x: auto;">
                            <table style="font-size: 0.75em; min-width: 600px;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Year</th>
                                        <th>At Close</th>
                                        <th>1</th>
                                        <th>2</th>
                                        <th>3</th>
                                        <th>4</th>
                                        <th>5</th>
                                    </tr>
                                </thead>
                                <tbody id="sponsorCashFlowsTable">
                                </tbody>
                            </table>
                        </div>
                        <div style="text-align: right; margin-top: 10px; padding: 10px; background: #fffacd; border-radius: 4px;">
                            <strong>MOIC:</strong> <span id="sensResultMOIC" style="font-size: 1.2em; color: #003d5c;">2.8x</span>
                            &nbsp;&nbsp;&nbsp;
                            <strong>IRR:</strong> <span id="sensResultIRR" style="font-size: 1.2em; color: #003d5c;">23.1%</span>
                        </div>
                    </div>

                    <!-- Sensitivity Tables -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Entry Multiple Sensitivity -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #005a82; font-size: 0.95em; margin-bottom: 15px; text-align: center; font-weight: bold;">IRR Sensitivity Analysis</h3>
                            <div style="overflow-x: auto;">
                                <table style="font-size: 0.75em; border-collapse: separate; border-spacing: 0;">
                                    <thead>
                                        <tr>
                                            <th style="border: none; background: none;"></th>
                                            <th style="border: none; background: none;"></th>
                                            <th colspan="5" style="text-align: center; padding: 8px; background: #f0f0f0; border-bottom: 2px solid #003d5c; font-weight: bold; color: #000 !important;">Entry Multiple</th>
                                        </tr>
                                        <tr>
                                            <th style="border: none; background: none;"></th>
                                            <th style="border: none; background: none;"></th>
                                            <th style="background: #f8f9fa; font-weight: 600; color: #000 !important;">8.4x</th>
                                            <th style="background: #f8f9fa; font-weight: 600; color: #000 !important;">9.4x</th>
                                            <th style="background: #f8f9fa; font-weight: 600; color: #000 !important;">10.4x</th>
                                            <th style="background: #f8f9fa; font-weight: 600; color: #000 !important;">11.4x</th>
                                            <th style="background: #f8f9fa; font-weight: 600; color: #000 !important;">12.4x</th>
                                        </tr>
                                    </thead>
                                    <tbody id="entryExitSensTable">
                                    </tbody>
                                </table>
                            </div>
                            <div style="text-align: right; margin-top: 8px; font-size: 0.75em; font-style: italic; color: #666;">
                                Target IRR: <span id="sensTargetIRR" style="color: #003d5c; font-weight: bold;">20.0%</span>
                            </div>
                        </div>

                        <!-- Exit Price Build -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #005a82; font-size: 0.85em; margin-bottom: 10px;">Exit Price Build</h3>
                            <table style="font-size: 0.75em;">
                                <tr>
                                    <td style="text-align: left;">LTM EBITDA</td>
                                    <td id="sensExitEbitda">52.4</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left;">Multiple</td>
                                    <td id="sensExitMultiple">10.4x</td>
                                </tr>
                                <tr style="font-weight: bold;">
                                    <td style="text-align: left;">EV</td>
                                    <td id="sensExitEV">544.8</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left;">(-) Debt</td>
                                    <td id="sensExitDebt">(82.8)</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left;">(+) Cash</td>
                                    <td id="sensExitCash">10.0</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left;">(-) Transaction Fees</td>
                                    <td id="sensExitTransFees">(6.4)</td>
                                </tr>
                                <tr style="font-weight: bold; background: #e8f4f8;">
                                    <td style="text-align: left;">Equity Value</td>
                                    <td id="sensExitEquityValue">466.6</td>
                                </tr>
                            </table>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <h4 style="color: #005a82; font-size: 0.8em; margin-bottom: 8px;">Ownership at Transaction Date</h4>
                                <table style="font-size: 0.75em;">
                                    <tr>
                                        <td style="text-align: left;">Sponsor Equity</td>
                                        <td id="sensOwnershipSponsor">126.4</td>
                                        <td id="sensOwnershipSponsorPct">90%</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;">Rollover Equity</td>
                                        <td id="sensOwnershipRollover">14.0</td>
                                        <td id="sensOwnershipRolloverPct">10%</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;">Management Incentive Plan</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <tr style="font-weight: bold;">
                                        <td style="text-align: left;">Total New Equity</td>
                                        <td id="sensOwnershipTotal">140.5</td>
                                        <td>100%</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0;">
                                <h4 style="color: #005a82; font-size: 0.8em; margin-bottom: 8px;">Ownership at Exit</h4>
                                <table style="font-size: 0.75em;">
                                    <tr>
                                        <td style="text-align: left; width: 60%;">Management Plan Stake at Exit</td>
                                        <td style="text-align: right;">15%</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;">Management Equity at Exit</td>
                                        <td id="sensMIPEquity">70.0</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;">Remaining Equity to Distribute</td>
                                        <td id="sensRemainingEquity">396.6</td>
                                    </tr>
                                    <tr>
                                        <td style="text-align: left;">Sponsor Stake</td>
                                        <td id="sensSponsorStakePct">90%</td>
                                    </tr>
                                    <tr style="font-weight: bold; background: #fffacd;">
                                        <td style="text-align: left;">Sponsor Equity at Exit</td>
                                        <td id="sensSponsorEquityAtExit">356.9</td>
                                    </tr>
                                </table>
                            </div>

                            <div style="text-align: right; margin-top: 12px; font-size: 0.75em; font-style: italic; color: #666;">
                                Target Returns: <span style="color: #003d5c; font-weight: bold;">20.0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROIC Tree & ROIC Analysis -->
                <div class="section full-width" style="overflow-x: auto;">
                    <h2>Return on Invested Capital (ROIC) Decomposition Tree</h2>
                    <div style="display: grid; grid-template-columns: 2fr 0.8fr; gap: 20px; min-width: 1200px;">
                        <!-- ROIC Tree Visualization -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 140px 45px 1fr; gap: 12px; align-items: center;">
                                <!-- Left: Main ROIC Chart -->
                                <div style="height: 200px;">
                                    <h4 style="text-align: center; font-size: 0.75em; margin-bottom: 6px; color: #003d5c;">Post-tax ROIC excl. goodwill</h4>
                                    <div style="height: 175px; position: relative;">
                                        <canvas id="roicMainChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Middle: Times sign and connecting lines -->
                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 320px; position: relative;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: white; border: 2px solid #003d5c; display: flex; align-items: center; justify-content: center; font-size: 1.4em; font-weight: bold; color: #003d5c; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10;">Ã—</div>
                                    <svg width="45" height="320" style="position: absolute; top: 0; left: 0;">
                                        <line x1="22" y1="160" x2="45" y2="65" stroke="#003d5c" stroke-width="2"/>
                                        <line x1="22" y1="160" x2="45" y2="255" stroke="#003d5c" stroke-width="2"/>
                                    </svg>
                                </div>
                                
                                <!-- Right: Two branches -->
                                <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 45px;">
                                    <!-- Top Branch: Margin -->
                                    <div style="height: 135px;">
                                        <div style="display: grid; grid-template-columns: 130px 40px 1fr; gap: 10px; align-items: start;">
                                            <!-- EBITDA Margin -->
                                            <div style="height: 135px;">
                                                <h4 style="text-align: center; font-size: 0.65em; margin-bottom: 5px; color: #003d5c;">EBITDA margin</h4>
                                                <div style="height: 120px; position: relative;">
                                                    <canvas id="ebitdaMarginChart"></canvas>
                                                </div>
                                            </div>
                                            
                                            <!-- "1-" sign -->
                                            <div style="display: flex; align-items: center; justify-content: center; height: 135px; position: relative;">
                                                <div style="width: 30px; height: 30px; border-radius: 50%; background: white; border: 2px solid #003d5c; display: flex; align-items: center; justify-content: center; font-size: 1em; font-weight: bold; color: #003d5c; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10;">1âˆ’</div>
                                                <svg width="40" height="135" style="position: absolute; top: 0; left: 0;">
                                                    <line x1="20" y1="67" x2="40" y2="16" stroke="#003d5c" stroke-width="1.5"/>
                                                    <line x1="20" y1="67" x2="40" y2="67" stroke="#003d5c" stroke-width="1.5"/>
                                                    <line x1="20" y1="67" x2="40" y2="118" stroke="#003d5c" stroke-width="1.5"/>
                                                </svg>
                                            </div>
                                            
                                            <!-- Margin components -->
                                            <div style="display: grid; grid-template-rows: repeat(3, 1fr); gap: 7px; height: 135px;">
                                                <div>
                                                    <h4 style="text-align: center; font-size: 0.55em; margin-bottom: 2px; color: #003d5c;">COGS/Revenues</h4>
                                                    <div style="height: 38px; position: relative;">
                                                        <canvas id="cogsChart"></canvas>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 style="text-align: center; font-size: 0.55em; margin-bottom: 2px; color: #003d5c;">SG&A/Revenues</h4>
                                                    <div style="height: 38px; position: relative;">
                                                        <canvas id="sgaChart"></canvas>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 style="text-align: center; font-size: 0.55em; margin-bottom: 2px; color: #003d5c;">D&A/Revenues</h4>
                                                    <div style="height: 38px; position: relative;">
                                                        <canvas id="depChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Bottom Branch: Capital Efficiency -->
                                    <div style="height: 135px;">
                                        <div style="display: grid; grid-template-columns: 130px 40px 1fr; gap: 10px; align-items: start;">
                                            <!-- Capital Turns -->
                                            <div style="height: 135px;">
                                                <h4 style="text-align: center; font-size: 0.65em; margin-bottom: 5px; color: #003d5c;">Capital efficiency (turns)</h4>
                                                <div style="height: 120px; position: relative;">
                                                    <canvas id="capitalTurnsChart"></canvas>
                                                </div>
                                            </div>
                                            
                                            <!-- "1/" sign -->
                                            <div style="display: flex; align-items: center; justify-content: center; height: 135px; position: relative;">
                                                <div style="width: 30px; height: 30px; border-radius: 50%; background: white; border: 2px solid #003d5c; display: flex; align-items: center; justify-content: center; font-size: 1em; font-weight: bold; color: #003d5c; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; line-height: 1;">1/</div>
                                                <svg width="40" height="135" style="position: absolute; top: 0; left: 0;">
                                                    <line x1="20" y1="67" x2="40" y2="42" stroke="#003d5c" stroke-width="1.5"/>
                                                    <line x1="20" y1="67" x2="40" y2="92" stroke="#003d5c" stroke-width="1.5"/>
                                                </svg>
                                            </div>
                                            
                                            <!-- Capital components -->
                                            <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 16px; height: 135px;">
                                                <div>
                                                    <h4 style="text-align: center; font-size: 0.55em; margin-bottom: 2px; color: #003d5c;">PP&EÂ²/Revenues</h4>
                                                    <div style="height: 52px; position: relative;">
                                                        <canvas id="ppeChart"></canvas>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h4 style="text-align: center; font-size: 0.55em; margin-bottom: 2px; color: #003d5c;">Working capital/Revenues</h4>
                                                    <div style="height: 52px; position: relative;">
                                                        <canvas id="wcChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ROIC Summary Table -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #005a82; font-size: 0.95em; margin-bottom: 12px;">ROIC Summary</h3>
                            <div style="background: linear-gradient(135deg, #003d5c 0%, #005a82 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 12px;">
                                <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">Average ROIC</div>
                                <div style="font-size: 2.2em; font-weight: bold;" id="roicAvg">0.0%</div>
                            </div>
                            <table style="font-size: 0.7em; width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Year</th>
                                        <th>ROIC</th>
                                    </tr>
                                </thead>
                                <tbody id="roicTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Full Projection Table -->
                <div class="section full-width">
                    <h2>5-Year Financial Projection ($ in Millions)</h2>
                    <div class="table-wrapper" style="overflow-x: scroll; border: 2px solid #003d5c; border-radius: 8px;">
                        <table id="projectionTable" style="min-width: 1200px; width: auto; margin: 0;">
                            <thead>
                                <tr id="yearHeaders">
                                    <th style="min-width: 220px;">Metric</th>
                                </tr>
                            </thead>
                            <tbody id="projectionBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SOFR_RATE = 0.045;
        let currentScenario = 'base';
        
        // Toggle sidebar function
        function toggleSidebar() {
            const content = document.querySelector('.content');
            if (content) {
                content.classList.toggle('sidebar-collapsed');
            }
        }
        
        // Update dashboard title with company name
        function updateTitle() {
            const companyName = document.getElementById('companyName').value.trim();
            const titleElement = document.getElementById('dashboardTitle');
            if (companyName) {
                titleElement.textContent = `ðŸ“Š ${companyName} LBO Model Dashboard`;
                document.title = `${companyName} LBO Model Dashboard`;
            } else {
                titleElement.textContent = 'ðŸ“Š LBO Model Dashboard';
                document.title = 'LBO Model Dashboard';
            }
        }
        
        // Handle Excel file upload
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('uploadStatus');
            
            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                statusDiv.textContent = 'âŒ Excel library not loaded. Please refresh the page.';
                console.error('XLSX library not found');
                return;
            }
            
            statusDiv.textContent = 'â³ Reading Excel file...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    console.log('Available sheets:', workbook.SheetNames);
                    
                    // Helper function to get cell value
                    function getCellValue(sheet, cell) {
                        const cellRef = sheet[cell];
                        const value = cellRef ? cellRef.v : null;
                        return value;
                    }
                    
                    // ===== 1. READ LTM DATA FROM "LBO Model" TAB, COLUMN J =====
                    if (!workbook.SheetNames.includes('LBO Model')) {
                        statusDiv.textContent = 'âŒ "LBO Model" sheet not found';
                        return;
                    }
                    const modelSheet = workbook.Sheets['LBO Model'];
                    
                    const ltmRevenue = getCellValue(modelSheet, 'J26');
                    const ltmEbitda = getCellValue(modelSheet, 'J33');
                    
                    console.log('LTM Revenue:', ltmRevenue);
                    console.log('LTM EBITDA:', ltmEbitda);
                    
                    // ===== 2. READ ASSUMPTIONS FROM "LBO Assumptions" TAB =====
                    if (!workbook.SheetNames.includes('LBO Assumptions')) {
                        statusDiv.textContent = 'âŒ "LBO Assumptions" sheet not found';
                        return;
                    }
                    const assumptionsSheet = workbook.Sheets['LBO Assumptions'];
                    
                    // Transaction Assumptions (Column D)
                    const companyName = getCellValue(assumptionsSheet, 'D7');
                    const purchaseMultiple = getCellValue(assumptionsSheet, 'D17');
                    const transFeesPct = getCellValue(assumptionsSheet, 'D18') * 100; // Convert to %
                    const finFeesPct = getCellValue(assumptionsSheet, 'D19') * 100; // Convert to %
                    const rolloverEquity = getCellValue(assumptionsSheet, 'D20') * 100; // Convert to %
                    const minCash = getCellValue(assumptionsSheet, 'D21') / 1000; // Convert to millions
                    const revolverAvail = getCellValue(assumptionsSheet, 'D22') / 1000; // Convert to millions
                    const exitMultiple = getCellValue(assumptionsSheet, 'D25');
                    
                    console.log('Purchase Multiple:', purchaseMultiple);
                    console.log('Exit Multiple:', exitMultiple);
                    
                    // ===== 3. READ BASE CASE SCENARIO (Rows 57, 62, 67, 73, 78, 83, 88) =====
                    // Columns F, G, H, I, J = Years 1-5
                    
                    // Row 57: Sales Growth (%)
                    const revenueGrowth = [
                        getCellValue(assumptionsSheet, 'F57') * 100,
                        getCellValue(assumptionsSheet, 'G57') * 100,
                        getCellValue(assumptionsSheet, 'H57') * 100,
                        getCellValue(assumptionsSheet, 'I57') * 100,
                        getCellValue(assumptionsSheet, 'J57') * 100
                    ];
                    
                    // Row 62: Gross Margin (%)
                    const grossMargin = [
                        getCellValue(assumptionsSheet, 'F62') * 100,
                        getCellValue(assumptionsSheet, 'G62') * 100,
                        getCellValue(assumptionsSheet, 'H62') * 100,
                        getCellValue(assumptionsSheet, 'I62') * 100,
                        getCellValue(assumptionsSheet, 'J62') * 100
                    ];
                    
                    // Row 67: SG&A (%)
                    const sgaMargin = [
                        getCellValue(assumptionsSheet, 'F67') * 100,
                        getCellValue(assumptionsSheet, 'G67') * 100,
                        getCellValue(assumptionsSheet, 'H67') * 100,
                        getCellValue(assumptionsSheet, 'I67') * 100,
                        getCellValue(assumptionsSheet, 'J67') * 100
                    ];
                    
                    // Row 73: CapEx (%)
                    const capexPercent = [
                        getCellValue(assumptionsSheet, 'F73') * 100,
                        getCellValue(assumptionsSheet, 'G73') * 100,
                        getCellValue(assumptionsSheet, 'H73') * 100,
                        getCellValue(assumptionsSheet, 'I73') * 100,
                        getCellValue(assumptionsSheet, 'J73') * 100
                    ];
                    
                    // Row 78: AR Days
                    const arDays = [
                        getCellValue(assumptionsSheet, 'F78'),
                        getCellValue(assumptionsSheet, 'G78'),
                        getCellValue(assumptionsSheet, 'H78'),
                        getCellValue(assumptionsSheet, 'I78'),
                        getCellValue(assumptionsSheet, 'J78')
                    ];
                    
                    // Row 83: Inventory Days
                    const invDays = [
                        getCellValue(assumptionsSheet, 'F83'),
                        getCellValue(assumptionsSheet, 'G83'),
                        getCellValue(assumptionsSheet, 'H83'),
                        getCellValue(assumptionsSheet, 'I83'),
                        getCellValue(assumptionsSheet, 'J83')
                    ];
                    
                    // Row 88: AP Days
                    const apDays = [
                        getCellValue(assumptionsSheet, 'F88'),
                        getCellValue(assumptionsSheet, 'G88'),
                        getCellValue(assumptionsSheet, 'H88'),
                        getCellValue(assumptionsSheet, 'I88'),
                        getCellValue(assumptionsSheet, 'J88')
                    ];
                    
                    console.log('Revenue Growth:', revenueGrowth);
                    console.log('Gross Margin:', grossMargin);
                    
                    // ===== 4. UPDATE DASHBOARD =====
                    
                    // Helper function to safely update fields
                    function safeSetValue(id, value) {
                        const element = document.getElementById(id);
                        if (element && value !== null && value !== undefined) {
                            element.value = value;
                        }
                    }
                    
                    // Update LTM data
                    safeSetValue('ltmRevenue', ltmRevenue / 1000); // Convert to millions
                    safeSetValue('ltmEbitda', ltmEbitda / 1000); // Convert to millions
                    
                    // Update company name
                    if (companyName) {
                        safeSetValue('companyName', companyName);
                        updateTitle();
                    }
                    
                    // Update transaction assumptions
                    safeSetValue('entryMultiple', purchaseMultiple);
                    safeSetValue('exitMultiple', exitMultiple);
                    safeSetValue('transFees', transFeesPct);
                    safeSetValue('finFees', finFeesPct);
                    safeSetValue('minCash', minCash / ltmRevenue * 1000 * 100); // Convert to % of revenue
                    
                    // Update scenario data arrays
                    if (revenueGrowth.every(v => v !== null)) {
                        scenarioData.base.revenueGrowth = revenueGrowth;
                    }
                    if (grossMargin.every(v => v !== null)) {
                        scenarioData.base.grossMargin = grossMargin;
                    }
                    if (sgaMargin.every(v => v !== null)) {
                        scenarioData.base.sgaMargin = sgaMargin;
                    }
                    if (capexPercent.every(v => v !== null)) {
                        scenarioData.base.capexPercent = capexPercent;
                    }
                    if (arDays.every(v => v !== null)) {
                        scenarioData.base.arDays = arDays;
                    }
                    if (invDays.every(v => v !== null)) {
                        scenarioData.base.invDays = invDays;
                    }
                    if (apDays.every(v => v !== null)) {
                        scenarioData.base.apDays = apDays;
                    }
                    
                    // Success message
                    statusDiv.textContent = 'âœ… Excel loaded successfully!';
                    setTimeout(() => {
                        statusDiv.textContent = '';
                    }, 3000);
                    
                    // Trigger recalculation
                    calculateLBO();
                    
                } catch (error) {
                    console.error('Error reading Excel:', error);
                    statusDiv.textContent = 'âŒ Error: ' + error.message;
                }
            };
            
            reader.onerror = function() {
                statusDiv.textContent = 'âŒ Error reading file';
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Scenario assumptions - matching Excel exactly
        const scenarioData = {
            base: {
                revenueGrowth: [4.74358, 4.74358, 4.74358, 4.74358, 4.74358],
                grossMargin: [9.996777409261096, 10.147249723612488, 10.29772203796388, 10.448194352315272, 10.598666666666666],
                sgaMargin: [5.370323565283576, 5.497260826164172, 5.624198087044768, 5.7511353479253645, 4.6086999999999996],
                capexPercent: [1.3882108342919006, 1.3882108342919006, 1.3882108342919006, 1.3882108342919006, 1.3882108342919006],
                arDays: [25.13974, 25.13974, 25.13974, 25.13974, 25.13974],
                invDays: [18.13576, 18.13576, 18.13576, 18.13576, 18.13576],
                apDays: [22.76213, 22.76213, 22.76213, 22.76213, 22.76213]
            },
            bear: {
                revenueGrowth: [4.74358, 4.49358, 4.2435799999999996, 3.9935799999999994, 3.743579999999999],
                grossMargin: [9.996777409261096, 9.996777409261096, 9.996777409261096, 9.996777409261096, 9.996777409261096],
                sgaMargin: [5.370323565283576, 5.370323565283576, 5.370323565283576, 5.370323565283576, 5.370323565283576],
                capexPercent: [1.3882108342919006, 1.6382108342919005, 1.8882108342919004, 2.1382108342919003, 2.3882108342919],
                arDays: [25.11871933333333, 25.710379333333332, 25.710379333333332, 25.710379333333332, 27.401276666666664],
                invDays: [18.82509, 18.82509, 18.82509, 18.82509, 21.58241],
                apDays: [21.427641333333334, 21.427641333333334, 21.427641333333334, 21.427641333333334, 16.089686666666665]
            },
            bull: {
                revenueGrowth: [8.5195, 8.5195, 8.5195, 8.5195, 8.5195],
                grossMargin: [11.285500000000001, 11.285500000000001, 11.285500000000001, 11.285500000000001, 11.285500000000001],
                sgaMargin: [5.0183241212102776, 5.145261382090874, 5.27219864297147, 5.399135903852066, 4.118075388439468],
                capexPercent: [1.219427379158456, 1.219427379158456, 1.219427379158456, 1.219427379158456, 1.219427379158456],
                arDays: [24.54808, 24.54808, 24.54808, 24.54808, 24.54808],
                invDays: [18.13576, 18.13576, 18.13576, 18.13576, 18.13576],
                apDays: [31.329289999999997, 31.329289999999997, 31.329289999999997, 31.329289999999997, 31.329289999999997]
            }
        };

        function setScenario(scenario) {
            currentScenario = scenario;
            
            // Update button states
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update input fields with scenario data
            updateScenarioInputs();
            
            // Recalculate
            calculateLBO();
        }

        function updateScenarioInputs() {
            const data = scenarioData[currentScenario];
            
            // Update all scenario inputs - with null checks
            for (let i = 0; i < 5; i++) {
                const revGrowthEl = document.getElementById(`revGrowth${i}`);
                const grossMarginEl = document.getElementById(`grossMargin${i}`);
                const sgaMarginEl = document.getElementById(`sgaMargin${i}`);
                const capexEl = document.getElementById(`capex${i}`);
                const arDaysEl = document.getElementById(`arDays${i}`);
                const invDaysEl = document.getElementById(`invDays${i}`);
                const apDaysEl = document.getElementById(`apDays${i}`);
                
                if (revGrowthEl) revGrowthEl.value = data.revenueGrowth[i].toFixed(2);
                if (grossMarginEl) grossMarginEl.value = data.grossMargin[i].toFixed(2);
                if (sgaMarginEl) sgaMarginEl.value = data.sgaMargin[i].toFixed(2);
                if (capexEl) capexEl.value = data.capexPercent[i].toFixed(2);
                if (arDaysEl) arDaysEl.value = data.arDays[i].toFixed(2);
                if (invDaysEl) invDaysEl.value = data.invDays[i].toFixed(2);
                if (apDaysEl) apDaysEl.value = data.apDays[i].toFixed(2);
            }
        }

        function createScenarioInputs() {
            const fields = ['revenueGrowth', 'grossMargin', 'sgaMargin', 'capex', 'arDays', 'invDays', 'apDays'];
            const containers = ['revenueGrowthInputs', 'grossMarginInputs', 'sgaMarginInputs', 'capexInputs', 'arDaysInputs', 'invDaysInputs', 'apDaysInputs'];
            
            fields.forEach((field, idx) => {
                const container = document.getElementById(containers[idx]);
                for (let i = 0; i < 5; i++) {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `${field}${i}`;
                    input.step = '0.01';
                    input.addEventListener('input', () => {
                        // Update scenario data
                        const value = parseFloat(input.value);
                        if (field === 'revenueGrowth') scenarioData[currentScenario].revenueGrowth[i] = value;
                        else if (field === 'grossMargin') scenarioData[currentScenario].grossMargin[i] = value;
                        else if (field === 'sgaMargin') scenarioData[currentScenario].sgaMargin[i] = value;
                        else if (field === 'capex') scenarioData[currentScenario].capexPercent[i] = value;
                        else if (field === 'arDays') scenarioData[currentScenario].arDays[i] = value;
                        else if (field === 'invDays') scenarioData[currentScenario].invDays[i] = value;
                        else if (field === 'apDays') scenarioData[currentScenario].apDays[i] = value;
                        
                        calculateLBO();
                    });
                    container.appendChild(input);
                }
            });
            
            updateScenarioInputs();
        }

        function formatCurrency(value) {
            return '$' + value.toFixed(1);
        }

        function formatNumber(value) {
            if (value < 0) {
                return '(' + Math.abs(value).toFixed(1) + ')';
            }
            return value.toFixed(1);
        }

        function calculateLBO() {
            // Get inputs
            const ltmEbitda = parseFloat(document.getElementById('ltmEbitda').value);
            const ltmRevenue = parseFloat(document.getElementById('ltmRevenue').value);
            const shares = parseFloat(document.getElementById('shares').value);
            const beginCash = parseFloat(document.getElementById('beginCash').value);
            const minCash = parseFloat(document.getElementById('minCash').value);
            
            const entryMultiple = parseFloat(document.getElementById('entryMultiple').value);
            const transactionFees = parseFloat(document.getElementById('transactionFees').value) / 100;
            const financingFees = parseFloat(document.getElementById('financingFees').value) / 100;
            const rolloverEquity = parseFloat(document.getElementById('rolloverEquity').value) / 100;
            
            const revolverSize = parseFloat(document.getElementById('revolverSize').value);
            const revolverSpread = parseFloat(document.getElementById('revolverSpread').value) / 10000;
            const termLoanLeverage = parseFloat(document.getElementById('termLoanLeverage').value);
            const termLoanSpread = parseFloat(document.getElementById('termLoanSpread').value) / 10000;
            const termLoanAmort = parseFloat(document.getElementById('termLoanAmort').value) / 100;
            const subDebtLeverage = parseFloat(document.getElementById('subDebtLeverage').value);
            const subDebtRate = parseFloat(document.getElementById('subDebtRate').value) / 100;
            const cashSweepEnabled = document.getElementById('cashSweep').checked;
            
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;
            const exitFees = parseFloat(document.getElementById('exitFees').value) / 100;
            const mipStake = parseFloat(document.getElementById('mipStake').value) / 100;
            
            const exitMultipleBase = parseFloat(document.getElementById('exitMultipleBase').value);
            const multipleExpBear = parseFloat(document.getElementById('multipleExpBear').value);
            const multipleExpBull = parseFloat(document.getElementById('multipleExpBull').value);
            
            // Calculate exit multiple based on scenario
            let exitMultiple = exitMultipleBase;
            if (currentScenario === 'bear') exitMultiple += multipleExpBear;
            if (currentScenario === 'bull') exitMultiple += multipleExpBull;

            // Sources & Uses
            const tev = ltmEbitda * entryMultiple;
            const termLoanAmount = ltmEbitda * termLoanLeverage;
            const subDebtAmount = ltmEbitda * subDebtLeverage;
            const totalDebt = termLoanAmount + subDebtAmount;
            
            const transactionFeeAmount = tev * transactionFees;
            const financingFeeAmount = totalDebt * financingFees;
            const totalUses = tev + transactionFeeAmount + financingFeeAmount + minCash;
            
            // Total Equity Needed = Total Uses - Total Debt - Cash from B/S
            const totalEquityNeeded = totalUses - totalDebt - beginCash;
            
            // Rollover is a % of the equity needed (not total uses)
            const rolloverAmount = totalEquityNeeded * rolloverEquity;
            const sponsorEquityAmount = totalEquityNeeded * (1 - rolloverEquity);
            
            // Calculate total sources
            const totalSources = rolloverAmount + sponsorEquityAmount + beginCash + termLoanAmount + subDebtAmount;

            // Initialize with ACTUAL beginning balance sheet values from Excel
            let currentRevenue = ltmRevenue;
            let currentTermLoan = termLoanAmount;
            let currentSubDebt = subDebtAmount;
            let currentRevolver = 0;
            let currentCash = minCash;
            
            // Beginning working capital from Excel Balance Sheet (J54, J55, J56, J63)
            let currentAR = 44.503;
            let currentInv = 30.328;
            let currentPrepaid = 6.311;
            let currentAP = 41.621;
            let currentPPE = 67.416; // PP&E Net of Accumulated Depreciation

            const projections = [];
            const cashFlows = [-sponsorEquityAmount]; // At Close (time 0)
            
            // Depreciation schedule (10 years straight-line)
            let depreciationSchedule = Array(6).fill(0);

            // First, add Year 0 (LTM/Historical) for reference - no projections, just historical data
            projections.push({
                year: 0,
                yearLabel: 'LTM',
                revenue: ltmRevenue,
                grossProfit: ltmRevenue * 0.09996777409261096, // Using base gross margin
                grossMargin: 0.09996777409261096,
                cogs: ltmRevenue * (1 - 0.09996777409261096),
                sga: ltmRevenue * 0.05370323565283576,
                sgaMargin: 0.05370323565283576,
                ebitda: ltmEbitda,
                ebitdaMargin: ltmEbitda / ltmRevenue,
                depreciation: 0,
                ebit: ltmEbitda,
                totalInterest: 0,
                feeAmort: 0,
                ebt: ltmEbitda,
                taxes: 0,
                netIncome: ltmEbitda,
                capex: 0,
                nwcChange: 0,
                unleveredFCF: 0,
                cfBeforeMandatory: 0,
                mandatoryAmort: 0,
                optionalPaydown: 0,
                cash: beginCash,
                revolver: 0,
                termLoan: 0,
                subDebt: 0,
                totalDebt: 0,
                netDebt: -beginCash,
                netDebtToEbitda: -beginCash / ltmEbitda,
                interestCoverage: 999,
                ar: currentAR,
                inv: currentInv,
                prepaid: currentPrepaid,
                ap: currentAP,
                ppe: currentPPE
            });
            
            // No cash flow for Year 0 in the cashFlows array - it's just for display

            for (let year = 1; year <= 5; year++) {
                const yearIndex = year - 1;
                
                // Get scenario-specific inputs (convert from % to decimal)
                const revenueGrowth = scenarioData[currentScenario].revenueGrowth[yearIndex] / 100;
                const grossMargin = scenarioData[currentScenario].grossMargin[yearIndex] / 100;
                const sgaMargin = scenarioData[currentScenario].sgaMargin[yearIndex] / 100;
                const capexPercent = scenarioData[currentScenario].capexPercent[yearIndex] / 100;
                const arDays = scenarioData[currentScenario].arDays[yearIndex];
                const invDays = scenarioData[currentScenario].invDays[yearIndex];
                const apDays = scenarioData[currentScenario].apDays[yearIndex];
                
                // Revenue
                const newRevenue = currentRevenue * (1 + revenueGrowth);
                
                // P&L
                const cogs = newRevenue * (1 - grossMargin);
                const grossProfit = newRevenue - cogs;
                const sga = newRevenue * sgaMargin;
                
                // CapEx and Depreciation
                const capex = newRevenue * capexPercent;
                
                // Add new capex to depreciation schedule
                for (let i = yearIndex; i < Math.min(yearIndex + 10, 5); i++) {
                    depreciationSchedule[i] += capex / 10;
                }
                
                const depreciation = depreciationSchedule[yearIndex];
                const ebitda = grossProfit - sga;
                const ebit = ebitda - depreciation;
                
                // Working capital - calculate new balances using days
                const newAR = arDays * (newRevenue / 365);
                const newInv = invDays * (cogs / 365);
                const newAP = apDays * (cogs / 365);
                
                // Prepaid expenses - assume constant as % of revenue (using Year 0 ratio)
                const prepaidRatio = 6.311 / ltmRevenue; // ~0.91%
                const newPrepaid = newRevenue * prepaidRatio;
                
                // PP&E calculation: Beginning PP&E + CapEx - Depreciation
                const newPPE = currentPPE + capex - depreciation;
                
                // NWC Change (Cash Flow perspective: increase in assets = use of cash = NEGATIVE)
                // WC = AR + Inv + Prepaid - AP
                // This calculates as (Old - New) for AR/Inv/Prepaid and -(Old - New) for AP
                // Result is NEGATIVE when NWC increases
                const nwcChange = (currentAR - newAR) + (currentInv - newInv) + (currentPrepaid - newPrepaid) - (currentAP - newAP);
                
                // Financing fee amortization
                const feeAmort = financingFeeAmount / 7;
                
                // ITERATIVE CALCULATION for circular reference
                let iterRevolver = currentRevolver;
                let iterTotalInterest = 0;
                let iterCashAfterMandatory = 0;
                
                const maxIterations = 100;
                const tolerance = 0.01;
                
                for (let iter = 0; iter < maxIterations; iter++) {
                    // Calculate interest based on current revolver estimate
                    const avgTermLoan = currentTermLoan;
                    const avgSubDebt = currentSubDebt;
                    const avgRevolver = (currentRevolver + iterRevolver) / 2;
                    
                    const termLoanInterest = avgTermLoan * (SOFR_RATE + termLoanSpread);
                    const subDebtInterest = avgSubDebt * subDebtRate;
                    const revolverInterest = avgRevolver * (SOFR_RATE + revolverSpread);
                    
                    // When cash sweep is ON (checked), charge interest
                    iterTotalInterest = cashSweepEnabled ? (termLoanInterest + subDebtInterest + revolverInterest) : 0;
                    
                    // Calculate cash flow with this interest
                    const iterEbt = ebit - iterTotalInterest - feeAmort;
                    const iterTaxes = Math.max(0, iterEbt * taxRate);
                    
                    // Unlevered FCF (before interest)
                    const iterUnleveredFCF = ebitda - capex - iterTaxes + nwcChange;
                    
                    // CF Before Mandatory = Unlevered FCF - Interest
                    const iterCFBeforeMandatory = iterUnleveredFCF - iterTotalInterest;
                    
                    // Mandatory amortization
                    const mandatoryAmort = termLoanAmount * termLoanAmort;
                    
                    iterCashAfterMandatory = currentCash + iterCFBeforeMandatory - mandatoryAmort;
                    
                    // Calculate new revolver balance
                    let newRevolver = currentRevolver;
                    
                    if (iterCashAfterMandatory < minCash && newRevolver < revolverSize) {
                        const draw = Math.min(minCash - iterCashAfterMandatory, revolverSize - newRevolver);
                        newRevolver += draw;
                        iterCashAfterMandatory += draw;
                    } else if (iterCashAfterMandatory > minCash && newRevolver > 0) {
                        const paydown = Math.min(iterCashAfterMandatory - minCash, newRevolver);
                        newRevolver -= paydown;
                        iterCashAfterMandatory -= paydown;
                    }
                    
                    // Check convergence
                    if (Math.abs(newRevolver - iterRevolver) < tolerance) {
                        iterRevolver = newRevolver;
                        break;
                    }
                    
                    iterRevolver = newRevolver;
                }
                
                // Use converged values
                const totalInterest = iterTotalInterest;
                const ebt = ebit - totalInterest - feeAmort;
                const taxes = Math.max(0, ebt * taxRate);
                const netIncome = ebt - taxes;
                
                // Unlevered FCF = EBITDA - CapEx - Taxes + NWC_Change
                const unleveredFCF = ebitda - capex - taxes + nwcChange;
                
                // CF Before Mandatory Debt = Unlevered FCF - Interest Expense
                const cfBeforeMandatory = unleveredFCF - totalInterest;
                
                // Mandatory amortization
                const mandatoryAmort = termLoanAmount * termLoanAmort;
                currentTermLoan = currentTermLoan - mandatoryAmort;
                
                let cashAfterMandatory = iterCashAfterMandatory;
                currentRevolver = iterRevolver;
                
                // Optional paydowns (always happen when TLB is prepayable)
                let optionalPaydown = 0;
                if (cashAfterMandatory > minCash && currentTermLoan > 0) {
                    optionalPaydown = Math.min(cashAfterMandatory - minCash, currentTermLoan);
                    currentTermLoan -= optionalPaydown;
                    cashAfterMandatory -= optionalPaydown;
                }
                
                currentCash = cashAfterMandatory;
                currentRevenue = newRevenue;
                currentAR = newAR;
                currentInv = newInv;
                currentPrepaid = newPrepaid;
                currentAP = newAP;
                currentPPE = newPPE;
                
                const totalDebtBalance = currentRevolver + currentTermLoan + currentSubDebt;
                const netDebt = totalDebtBalance - currentCash;
                const netDebtToEbitda = netDebt / ebitda;
                const interestCoverage = totalInterest > 0 ? ebitda / totalInterest : 999;
                
                projections.push({
                    year,
                    yearLabel: (2025 + year).toString(), // 2026, 2027, 2028, 2029, 2030
                    revenue: newRevenue,
                    grossProfit,
                    grossMargin,
                    cogs,
                    sga,
                    sgaMargin,
                    ebitda,
                    ebitdaMargin: ebitda / newRevenue,
                    depreciation,
                    ebit,
                    totalInterest,
                    feeAmort,
                    ebt,
                    taxes,
                    netIncome,
                    capex,  // Store as positive, display as negative
                    nwcChange,  // Already has correct sign (negative when NWC increases)
                    unleveredFCF,
                    cfBeforeMandatory,
                    mandatoryAmort,
                    optionalPaydown,
                    cash: currentCash,
                    revolver: currentRevolver,
                    termLoan: currentTermLoan,
                    subDebt: currentSubDebt,
                    totalDebt: totalDebtBalance,
                    netDebt,
                    netDebtToEbitda,
                    interestCoverage,
                    ar: newAR,
                    inv: newInv,
                    prepaid: newPrepaid,
                    ap: newAP,
                    ppe: newPPE
                });
                
                // Build cash flows array: [At Close, Year 1, Year 2, Year 3, Year 4, Year 5]
                if (year === 5) {
                    const exitEV = ebitda * exitMultiple;
                    const exitFeeAmount = exitEV * exitFees;
                    const totalEquityValue = exitEV - netDebt - exitFeeAmount;
                    
                    // Management Incentive Plan (MIP)
                    const mipEquity = totalEquityValue * mipStake;
                    const remainingEquity = totalEquityValue - mipEquity;
                    
                    // Sponsor gets its share of remaining equity
                    const sponsorStake = 1 - rolloverEquity;
                    const equityProceeds = remainingEquity * sponsorStake;
                    
                    cashFlows.push(equityProceeds); // Year 5 - exit proceeds
                } else {
                    cashFlows.push(0); // Years 1-4 - no cash flows
                }
            }

            // Calculate returns
            const irr = calculateIRR(cashFlows);
            const moic = cashFlows[cashFlows.length - 1] / Math.abs(cashFlows[0]);

            // Final year (Year 5 is index 5 in projections array now)
            const finalYear = projections[5];
            const exitEV = finalYear.ebitda * exitMultiple;
            const exitFeeAmount = exitEV * exitFees;
            const totalEquityValue = exitEV - finalYear.netDebt - exitFeeAmount;
            const mipEquity = totalEquityValue * mipStake;
            const remainingEquity = totalEquityValue - mipEquity;
            const sponsorStake = 1 - rolloverEquity;
            const finalEquityValue = remainingEquity * sponsorStake;

            // Update displays
            const irrEl = document.getElementById('irr');
            const moicEl = document.getElementById('moic');
            const equityValueExitEl = document.getElementById('equityValueExit');
            const valuePerShareEl = document.getElementById('valuePerShare');
            
            if (irrEl) irrEl.textContent = (irr * 100).toFixed(1);
            if (moicEl) moicEl.textContent = moic.toFixed(2);
            if (equityValueExitEl) equityValueExitEl.textContent = formatCurrency(finalEquityValue);
            if (valuePerShareEl) valuePerShareEl.textContent = (finalEquityValue / shares).toFixed(2);
            
            // Legacy elements (may not exist anymore)
            const tevEl = document.getElementById('tev');
            const totalLeverageEl = document.getElementById('totalLeverage');
            const sponsorEquityEl = document.getElementById('sponsorEquity');
            const totalDebtSourcesEl = document.getElementById('totalDebtSources');
            const pctEquityEl = document.getElementById('pctEquity');
            const pctDebtEl = document.getElementById('pctDebt');
            
            if (tevEl) tevEl.textContent = formatCurrency(tev);
            if (totalLeverageEl) totalLeverageEl.textContent = (totalDebt / ltmEbitda).toFixed(2);
            if (sponsorEquityEl) sponsorEquityEl.textContent = formatCurrency(sponsorEquityAmount);
            if (totalDebtSourcesEl) totalDebtSourcesEl.textContent = formatCurrency(totalDebt);
            if (pctEquityEl) pctEquityEl.textContent = ((sponsorEquityAmount + rolloverAmount) / totalUses * 100).toFixed(1);
            if (pctDebtEl) pctDebtEl.textContent = (totalDebt / totalUses * 100).toFixed(1);

            // Update Sources and Uses summary (left side)
            const suLtmEbitdaEl = document.getElementById('suLtmEbitda');
            const suMultipleEl = document.getElementById('suMultiple');
            const suTEVEl = document.getElementById('suTEV');
            const suRefDebtEl = document.getElementById('suRefDebt');
            const suCashToShareholdersEl = document.getElementById('suCashToShareholders');
            
            if (suLtmEbitdaEl) suLtmEbitdaEl.textContent = ltmEbitda.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (suMultipleEl) suMultipleEl.textContent = entryMultiple.toFixed(1) + 'x';
            if (suTEVEl) suTEVEl.textContent = tev.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (suRefDebtEl) suRefDebtEl.textContent = '-';
            if (suCashToShareholdersEl) suCashToShareholdersEl.textContent = tev.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Populate Sources table
            const sourcesData = [
                { label: 'Management Rollover', amount: rolloverAmount, color: '' },
                { label: 'Sponsor Equity', amount: sponsorEquityAmount, color: '' },
                { label: 'Cash', amount: beginCash, color: '' },
                { label: 'Term Loan B', amount: termLoanAmount, color: '' },
                { label: 'Sub. Debt', amount: subDebtAmount, color: '' },
                { label: 'Total', amount: totalSources, color: 'bold' }
            ];

            const sourcesTableBody = document.getElementById('sourcesTableBody');
            if (sourcesTableBody) {
                sourcesTableBody.innerHTML = '';
                sourcesData.forEach(item => {
                    const row = sourcesTableBody.insertRow();
                    const isBold = item.color === 'bold';
                    const borderStyle = isBold ? 'border-top: 2px solid #003d5c; border-bottom: 2px solid #003d5c;' : '';
                    const fontWeight = isBold ? 'font-weight: bold;' : '';
                    
                    row.innerHTML = `
                        <td style="text-align: left; padding: 6px 0; ${borderStyle} ${fontWeight}">${item.label}</td>
                        <td style="text-align: right; padding: 6px 0; ${borderStyle} ${fontWeight}">${item.amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                        <td style="text-align: right; padding: 6px 0; ${borderStyle} ${fontWeight}">${(item.amount / ltmEbitda).toFixed(1)}x</td>
                        <td style="text-align: right; padding: 6px 0; ${borderStyle} ${fontWeight}">${(item.amount / totalSources * 100).toFixed(1)}%</td>
                    `;
                });
            }

            // Populate Uses table
            const usesData = [
                { label: 'Cash to Shareholders', amount: tev, color: '' },
                { label: 'Minimum Cash Balance', amount: minCash, color: '' },
                { label: 'Refinance Existing', amount: 0, color: '' },
                { label: 'Transaction Fee', amount: transactionFeeAmount, color: '' },
                { label: 'Financing Fee', amount: financingFeeAmount, color: '' },
                { label: 'Total', amount: totalUses, color: 'bold' }
            ];

            const usesTableBody = document.getElementById('usesTableBody');
            if (usesTableBody) {
                usesTableBody.innerHTML = '';
                usesData.forEach(item => {
                    const row = usesTableBody.insertRow();
                    const isBold = item.color === 'bold';
                    const borderStyle = isBold ? 'border-top: 2px solid #003d5c; border-bottom: 2px solid #003d5c;' : '';
                    const fontWeight = isBold ? 'font-weight: bold;' : '';
                    
                    row.innerHTML = `
                        <td style="text-align: left; padding: 6px 0; ${borderStyle} ${fontWeight}">${item.label}</td>
                        <td style="text-align: right; padding: 6px 0; ${borderStyle} ${fontWeight}">${item.amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}</td>
                        <td style="text-align: right; padding: 6px 0; ${borderStyle} ${fontWeight}">${(item.amount / ltmEbitda).toFixed(1)}x</td>
                        <td style="text-align: right; padding: 6px 0; ${borderStyle} ${fontWeight}">${(item.amount / totalUses * 100).toFixed(1)}%</td>
                    `;
                });
            }

            // Update Returns Sensitivity Section - with null checks
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            updateElement('sensLtmEbitda', formatNumber(ltmEbitda));
            updateElement('sensPurchaseMultiple', entryMultiple.toFixed(1) + 'x');
            updateElement('sensTEV', formatNumber(tev));
            updateElement('sensCashToShareholders', formatNumber(tev));
            updateElement('sensTransFees', formatNumber(transactionFeeAmount));
            updateElement('sensFinFees', formatNumber(financingFeeAmount));
            updateElement('sensMinCash', formatNumber(minCash));
            updateElement('sensCashFromBS', beginCash > 0 ? '(' + formatNumber(beginCash) + ')' : '-');
            updateElement('sensNewDebt', '(' + formatNumber(totalDebt) + ')');
            updateElement('sensRollover', '(' + formatNumber(rolloverAmount) + ')');
            updateElement('sensSponsorEquity', formatNumber(sponsorEquityAmount));
            
            // Exit Price Build
            updateElement('sensExitEbitda', formatNumber(finalYear.ebitda));
            updateElement('sensExitMultiple', exitMultiple.toFixed(1) + 'x');
            updateElement('sensExitEV', formatNumber(exitEV));
            updateElement('sensExitDebt', '(' + formatNumber(finalYear.totalDebt) + ')');
            updateElement('sensExitCash', formatNumber(finalYear.cash));
            updateElement('sensExitTransFees', '(' + formatNumber(exitFeeAmount) + ')');
            updateElement('sensExitEquityValue', formatNumber(totalEquityValue));
            
            // Ownership
            updateElement('sensOwnershipSponsor', formatNumber(sponsorEquityAmount));
            updateElement('sensOwnershipSponsorPct', (sponsorStake * 100).toFixed(0) + '%');
            updateElement('sensOwnershipRollover', formatNumber(rolloverAmount));
            updateElement('sensOwnershipRolloverPct', (rolloverEquity * 100).toFixed(0) + '%');
            updateElement('sensOwnershipTotal', formatNumber(sponsorEquityAmount + rolloverAmount));
            
            updateElement('sensMIPEquity', formatNumber(mipEquity));
            updateElement('sensRemainingEquity', formatNumber(remainingEquity));
            updateElement('sensSponsorStakePct', (sponsorStake * 100).toFixed(0) + '%');
            updateElement('sensSponsorEquityAtExit', formatNumber(finalEquityValue));
            
            updateElement('sensResultMOIC', moic.toFixed(2) + 'x');
            updateElement('sensResultIRR', (irr * 100).toFixed(1) + '%');
            
            // Sponsor Cash Flows Table
            const cashFlowsTableBody = document.getElementById('sponsorCashFlowsTable');
            if (cashFlowsTableBody) {
                let cashFlowHTML = '<tr><td style="text-align: left; font-weight: 600;">Sponsor Cash Flows</td>';
                cashFlows.forEach((cf, i) => {
                    if (i === 0) {
                        // At Close - negative (investment)
                        cashFlowHTML += '<td>(' + formatNumber(Math.abs(cf)) + ')</td>';
                    } else if (i === 5) {
                        // Year 5 - positive (exit)
                        cashFlowHTML += '<td>' + formatNumber(cf) + '</td>';
                    } else {
                        // Years 1-4 - zero
                        cashFlowHTML += '<td>-</td>';
                    }
                });
                cashFlowHTML += '</tr>';
                cashFlowsTableBody.innerHTML = cashFlowHTML;
            }
            
            // Entry/Exit Multiple Sensitivity Table
            const entryMultiples = [8.4, 9.4, 10.4, 11.4, 12.4];
            const exitMultiples = [12.4, 11.4, 10.4, 9.4, 8.4];
            const sensTableBody = document.getElementById('entryExitSensTable');
            
            // Get IRR target from input
            const irrTarget = parseFloat(document.getElementById('irrTarget').value) / 100;
            updateElement('sensTargetIRR', (irrTarget * 100).toFixed(1) + '%');
            
            if (sensTableBody) {
                sensTableBody.innerHTML = '';
                
                exitMultiples.forEach((exitMult, idx) => {
                    const row = sensTableBody.insertRow();
                    
                    // First column: Exit Multiple label (only show on first row)
                    if (idx === 0) {
                        const labelCell = row.insertCell();
                        labelCell.innerHTML = '<div style="writing-mode: vertical-rl; text-align: center; font-weight: bold; font-size: 0.9em; padding: 0; color: #000 !important;">Exit Multiple</div>';
                        labelCell.style.background = '#f0f0f0';
                        labelCell.style.borderRight = '2px solid #003d5c';
                        labelCell.style.padding = '10px 5px';
                        labelCell.style.verticalAlign = 'middle';
                        labelCell.rowSpan = exitMultiples.length;
                    }
                    
                    // Exit multiple value
                    const exitMultCell = row.insertCell();
                    exitMultCell.textContent = exitMult.toFixed(1) + 'x';
                    exitMultCell.style.fontWeight = '600';
                    exitMultCell.style.background = '#f8f9fa';
                    exitMultCell.style.textAlign = 'center';
                    exitMultCell.style.padding = '10px';
                    exitMultCell.style.borderRight = '2px solid #ddd';
                    exitMultCell.style.color = '#000 !important';
                    
                    entryMultiples.forEach(entryMult => {
                        // Quick IRR calc with different multiples
                        const tempTEV = ltmEbitda * entryMult;
                        const tempTransFees = tempTEV * transactionFees;
                        const tempFinFees = totalDebt * financingFees;
                        const tempUses = tempTEV + tempTransFees + tempFinFees + minCash - beginCash;
                        const tempRollover = tempUses * rolloverEquity;
                        const tempSponsorEquity = tempUses - totalDebt - tempRollover;
                        
                        const tempExitEV = finalYear.ebitda * exitMult;
                        const tempExitFees = tempExitEV * exitFees;
                        const tempTotalEquity = tempExitEV - finalYear.netDebt - tempExitFees;
                        const tempMIPEquity = tempTotalEquity * mipStake;
                        const tempRemaining = tempTotalEquity - tempMIPEquity;
                        const tempSponsorStake = 1 - rolloverEquity;
                        const tempExitProceeds = tempRemaining * tempSponsorStake;
                        
                        const tempCF = [-tempSponsorEquity, 0, 0, 0, 0, tempExitProceeds];
                        const tempIRR = calculateIRR(tempCF);
                        
                        const cell = row.insertCell();
                        cell.textContent = (tempIRR * 100).toFixed(1) + '%';
                        cell.style.textAlign = 'center';
                        cell.style.padding = '10px';
                        cell.style.fontWeight = '500';
                        cell.style.fontSize = '0.85em';
                        
                        // Highlight current scenario with bold border
                        if (Math.abs(entryMult - entryMultiple) < 0.1 && Math.abs(exitMult - exitMultiple) < 0.1) {
                            cell.style.border = '3px solid #003d5c';
                            cell.style.fontWeight = 'bold';
                        }
                        
                        // Color coding - ONLY GREEN if above target, otherwise white
                        if (tempIRR > irrTarget) {
                            cell.style.background = '#90EE90'; // Green - above target
                            cell.style.color = '#000 !important'; // Force black text
                        } else {
                            cell.style.background = '#ffffff'; // White - at or below target
                            cell.style.color = '#000 !important'; // Force black text
                        }
                    });
                });
            }

            // Create ROIC Tree with multiple mini-charts (McKinsey style)
            const projYears = projections.filter(p => p.year > 0);
            const years = projYears.map(p => p.year);
            
            // Helper function to create mini bar charts
            function createMiniChart(canvasId, data, color, isPercentage = true, maxVal = null) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;
                
                if (window[canvasId + 'Instance']) {
                    window[canvasId + 'Instance'].destroy();
                }
                
                window[canvasId + 'Instance'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [{
                            data: data,
                            backgroundColor: color,
                            borderColor: color,
                            borderWidth: 1,
                            barPercentage: 0.95,
                            categoryPercentage: 0.95
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    title: function(context) {
                                        return 'Year ' + context[0].label;
                                    },
                                    label: function(context) {
                                        return isPercentage ? 
                                            context.parsed.y.toFixed(1) + '%' : 
                                            context.parsed.y.toFixed(2) + 'x';
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                offset: 2,
                                color: '#003d5c',
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                },
                                formatter: function(value) {
                                    if (isPercentage) {
                                        return value.toFixed(1);
                                    } else {
                                        return value.toFixed(1);
                                    }
                                },
                                clip: false
                            }
                        },
                        layout: {
                            padding: {
                                top: 20,
                                left: 5,
                                right: 5
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: maxVal,
                                ticks: {
                                    font: { size: 8 },
                                    maxTicksLimit: 4,
                                    callback: function(value) {
                                        return isPercentage ? value.toFixed(0) : value.toFixed(1);
                                    }
                                },
                                grid: { 
                                    display: true,
                                    drawBorder: false,
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                ticks: { 
                                    font: { size: 9 },
                                    maxRotation: 0
                                },
                                grid: { display: false }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
            
            // Calculate all metrics for ROIC tree
            // ROIC = EBITDA Margin Ã— Capital Turns
            const roicData = projYears.map(p => {
                const ebitdaMargin = p.ebitda / p.revenue;
                const wc = p.ar + p.inv + p.prepaid - p.ap;
                const totalCapital = p.ppe + wc;
                const capitalTurns = p.revenue / totalCapital;
                return (ebitdaMargin * capitalTurns * 100); // Convert to percentage
            });
            
            const ebitdaMarginData = projYears.map(p => (p.ebitda / p.revenue * 100));
            const cogsRevenueData = projYears.map(p => (p.cogs / p.revenue * 100));
            const sgaRevenueData = projYears.map(p => (p.sga / p.revenue * 100));
            const depRevenueData = projYears.map(p => (p.depreciation / p.revenue * 100));
            
            // PP&E/Revenue - using actual PP&E from balance sheet
            const ppeRevenueData = projYears.map(p => (p.ppe / p.revenue * 100));
            
            // Working Capital/Revenue - using AR + Inv + Prepaid - AP
            const wcRevenueData = projYears.map(p => {
                const wc = p.ar + p.inv + p.prepaid - p.ap;
                return (wc / p.revenue * 100);
            });
            
            // Capital Turns = 1 / (PPE/Revenue + WC/Revenue)
            // This is Revenue / (PPE + WC)
            const capitalTurnsData = projYears.map(p => {
                const wc = p.ar + p.inv + p.prepaid - p.ap;
                const totalCapital = p.ppe + wc;
                return p.revenue / totalCapital;
            });
            
            // Create all mini-charts
            createMiniChart('roicMainChart', roicData, '#003d5c', true, null);
            createMiniChart('ebitdaMarginChart', ebitdaMarginData, '#0073b1', true, null);
            createMiniChart('cogsChart', cogsRevenueData, '#5e5e5e', true, 100);
            createMiniChart('sgaChart', sgaRevenueData, '#5e5e5e', true, null);
            createMiniChart('depChart', depRevenueData, '#5e5e5e', true, null);
            createMiniChart('capitalTurnsChart', capitalTurnsData, '#00a3e0', false, null);
            createMiniChart('ppeChart', ppeRevenueData, '#8c8c8c', true, null);
            createMiniChart('wcChart', wcRevenueData, '#8c8c8c', true, null);

            // Calculate ROIC (Return on Invested Capital)
            // ROIC = EBITDA Margin Ã— Capital Turns
            // EBITDA Margin = EBITDA / Revenue
            // Capital Turns = Revenue / (PP&E + Working Capital)
            const roicTableBody = document.getElementById('roicTable');
            if (roicTableBody) {
                roicTableBody.innerHTML = '';
                let totalROIC = 0;
                let roicCount = 0;

                projections.filter(p => p.year > 0).forEach(proj => {
                    // EBITDA Margin
                    const ebitdaMargin = proj.ebitda / proj.revenue;
                    
                    // Working Capital = AR + Inventory + Prepaid - AP
                    const wc = proj.ar + proj.inv + proj.prepaid - proj.ap;
                    
                    // Capital Turns = Revenue / (PP&E + WC)
                    const totalCapital = proj.ppe + wc;
                    const capitalTurns = proj.revenue / totalCapital;
                    
                    // ROIC = EBITDA Margin Ã— Capital Turns
                    const roic = ebitdaMargin * capitalTurns;

                    const row = roicTableBody.insertRow();
                    row.innerHTML = `
                        <td style="text-align: left; font-weight: 600;">Year ${proj.year}</td>
                        <td style="text-align: right; font-weight: bold; font-size: 1.1em; color: ${roic >= 0.15 ? '#2ecc71' : roic >= 0.10 ? '#f39c12' : '#e74c3c'};">
                            ${(roic * 100).toFixed(1)}%
                        </td>
                    `;

                    totalROIC += roic;
                    roicCount++;
                });

                // Calculate average ROIC
                const avgROIC = totalROIC / roicCount;
                updateElement('roicAvg', (avgROIC * 100).toFixed(1) + '%');
            }

            // Update table
            const yearHeaders = document.getElementById('yearHeaders');
            yearHeaders.innerHTML = '<th style="background: #003d5c; color: white;">Metric</th>';
            projections.forEach(proj => {
                if (proj.year === 0) {
                    yearHeaders.innerHTML += `<th style="background: #003d5c; color: white;">Year 0<br/>(LTM)</th>`;
                } else {
                    yearHeaders.innerHTML += `<th style="background: #003d5c; color: white;">Year ${proj.year}<br/>(${proj.yearLabel})</th>`;
                }
            });

            const metrics = [
                { label: 'INCOME STATEMENT', isHeader: true },
                { label: 'Revenue', key: 'revenue', formatter: formatNumber },
                { label: 'COGS', key: 'cogs', formatter: formatNumber },
                { label: 'Gross Profit', key: 'grossProfit', formatter: formatNumber, bold: true },
                { label: 'Gross Margin (%)', key: 'grossMargin', formatter: v => (v * 100).toFixed(1) + '%', indent: true, italic: true },
                { label: '', isBlank: true },
                { label: 'SG&A', key: 'sga', formatter: formatNumber },
                { label: 'SG&A Margin (%)', key: 'sgaMargin', formatter: v => (v * 100).toFixed(1) + '%', indent: true, italic: true },
                { label: '', isBlank: true },
                { label: 'EBITDA', key: 'ebitda', formatter: formatNumber, bold: true },
                { label: 'EBITDA Margin (%)', key: 'ebitdaMargin', formatter: v => (v * 100).toFixed(1) + '%', indent: true, italic: true },
                { label: '', isBlank: true },
                { label: 'D&A', key: 'depreciation', formatter: formatNumber },
                { label: 'EBIT', key: 'ebit', formatter: formatNumber, bold: true },
                { label: '', isBlank: true },
                { label: 'Interest Expense', key: 'totalInterest', formatter: formatNumber },
                { label: 'Fee Amortization', key: 'feeAmort', formatter: formatNumber },
                { label: 'EBT', key: 'ebt', formatter: formatNumber, bold: true },
                { label: '', isBlank: true },
                { label: 'Taxes', key: 'taxes', formatter: formatNumber },
                { label: 'Net Income', key: 'netIncome', formatter: formatNumber, bold: true },
                { label: '', isBlank: true },
                { label: '', isHeader: true },
                { label: 'CASH FLOW', isHeader: true },
                { label: 'EBITDA', key: 'ebitda', formatter: formatNumber },
                { label: 'CapEx', key: 'capex', formatter: v => v < 0 ? '(' + Math.abs(v).toFixed(1) + ')' : v.toFixed(1) },
                { label: 'Taxes', key: 'taxes', formatter: v => v < 0 ? '(' + Math.abs(v).toFixed(1) + ')' : v.toFixed(1) },
                { label: 'NWC Change', key: 'nwcChange', formatter: formatNumber },
                { label: 'Unlevered FCF', key: 'unleveredFCF', formatter: formatNumber },
                { label: 'Interest Expense', key: 'totalInterest', formatter: v => v < 0 ? '(' + Math.abs(v).toFixed(1) + ')' : v.toFixed(1) },
                { label: 'CF Before Mandatory Debt', key: 'cfBeforeMandatory', formatter: formatNumber },
                { label: '', isHeader: true },
                { label: 'WORKING CAPITAL', isHeader: true },
                { label: 'Accounts Receivable', key: 'ar', formatter: formatNumber },
                { label: 'Inventory', key: 'inv', formatter: formatNumber },
                { label: 'Accounts Payable', key: 'ap', formatter: formatNumber },
                { label: '', isHeader: true },
                { label: 'DEBT SCHEDULE', isHeader: true },
                { label: 'Mandatory Amort', key: 'mandatoryAmort', formatter: formatNumber },
                { label: 'Optional Paydown', key: 'optionalPaydown', formatter: formatNumber },
                { label: 'Cash', key: 'cash', formatter: formatNumber },
                { label: 'Revolver', key: 'revolver', formatter: formatNumber },
                { label: 'Term Loan B', key: 'termLoan', formatter: formatNumber },
                { label: 'Sub Debt', key: 'subDebt', formatter: formatNumber },
                { label: 'Total Debt', key: 'totalDebt', formatter: formatNumber },
                { label: 'Net Debt', key: 'netDebt', formatter: formatNumber, bold: true },
                { label: '', isBlank: true },
                { label: 'Net Debt/EBITDA', key: 'netDebtToEbitda', formatter: v => v < 0 ? '(' + Math.abs(v).toFixed(2) + 'x)' : v.toFixed(2) + 'x', indent: true, italic: true },
                { label: 'Interest Coverage', key: 'interestCoverage', formatter: v => v > 100 ? 'N/A' : (v < 0 ? '(' + Math.abs(v).toFixed(2) + 'x)' : v.toFixed(2) + 'x'), indent: true, italic: true }
            ];

            const tbody = document.getElementById('projectionBody');
            tbody.innerHTML = '';

            metrics.forEach(metric => {
                const row = tbody.insertRow();
                if (metric.isHeader) {
                    row.className = 'metric-section';
                    row.innerHTML = `<td colspan="6">${metric.label}</td>`;
                } else if (metric.isBlank) {
                    row.innerHTML = `<td colspan="6" style="height: 10px; background: transparent; border: none;"></td>`;
                } else {
                    const labelStyle = [];
                    if (metric.indent) labelStyle.push('padding-left: 30px');
                    if (metric.italic) labelStyle.push('font-style: italic');
                    if (metric.bold) labelStyle.push('font-weight: bold');
                    
                    const styleAttr = labelStyle.length > 0 ? ` style="${labelStyle.join('; ')}"` : '';
                    let rowHTML = `<td${styleAttr}>${metric.label}</td>`;
                    
                    projections.forEach(proj => {
                        const value = proj[metric.key];
                        const cellStyle = metric.bold ? ' style="font-weight: bold"' : '';
                        rowHTML += `<td${cellStyle}>${metric.formatter(value)}</td>`;
                    });
                    row.innerHTML = rowHTML;
                }
            });
        }

        function calculateIRR(cashFlows) {
            const maxIter = 100;
            const tolerance = 0.0001;
            let rate = 0.1;

            for (let i = 0; i < maxIter; i++) {
                let npv = 0;
                let dnpv = 0;

                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + rate, j);
                    dnpv += -j * cashFlows[j] / Math.pow(1 + rate, j + 1);
                }

                const newRate = rate - npv / dnpv;
                if (Math.abs(newRate - rate) < tolerance) return newRate;
                rate = newRate;
            }
            return rate;
        }

        // Event listeners
        document.querySelectorAll('input').forEach(input => {
            if (input.type === 'checkbox') {
                input.addEventListener('change', calculateLBO);
            } else if (input.type === 'number' && !input.id.match(/revGrowth|grossMargin|sgaMargin|capex|arDays|invDays|apDays/)) {
                input.addEventListener('input', calculateLBO);
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            createScenarioInputs();
            
            // Set Base as default and populate
            currentScenario = 'base';
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                if (btn.textContent === 'BASE') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Small delay to ensure inputs are created
            setTimeout(() => {
                updateScenarioInputs();
                calculateLBO();
            }, 100);
        });
    </script>
</body>
</html>